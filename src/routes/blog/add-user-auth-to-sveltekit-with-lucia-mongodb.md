---
title: How to add user authentication to SvelteKit with Lucia and MongoDB
author: Ross Keenan
createdAt: 2023-02-11
description: A step-by-step guide to adding user authentication to SvelteKit with Lucia and MongoDB
tags:
  - SvelteKit
  - Lucia
  - Mongodb
  - Auth
---

<script>
    import Admonition from '$lib/components/Admonition.svelte';
</script>

In this tutorial, we'll be adding user authentication to a SvelteKit app using <a target="_blank" href="https://lucia-auth.vercel.app">Lucia</a> and <a target="_blank" href="https://www.mongodb.com/">MongoDB</a>. Lucia is a framework-agnostic user-authentication library you can use with most databases. We'll be using MongoDB, but you can use any database that Lucia supports. Lucia also supports multiple authentication methods, such as email/password, OAuth, and more. We'll be using email/password authentication.

## Prerequisites

- A MongoDB database (you can use <a target="_blank" href="https://www.mongodb.com/cloud/atlas">MongoDB Atlas</a> for free).
- A SvelteKit app

## Configuring Lucia

### Install Lucia

Lucia is split into multiple packages. We'll need the core package (`lucia-auth`), the MongoDB adapter (`@lucia-auth/adapter-mongoose`), and the SvelteKit adapter (`@lucia-auth/sveltekit`). You can install all of these with npm:

```bash
npm i lucia-auth @lucia-auth/adapter-mongoose @lucia-auth/sveltekit
```

### Initialise Lucia and the MongoDB adapter

In `src/lib/server/lucia.ts`, we'll initialise Lucia and the MongoDB adapter. We'll also create a `User` model that we'll use to interact with our users in the database. The `Session` model stores information about the user's session, and the `Key` model stores information about the user's password. It can be used to store other authentication methods, such as OAuth.

```ts
import { dev } from '$app/environment';
import adapter from '@lucia-auth/adapter-mongoose';
import lucia from 'lucia-auth';
import mongoose, { Model } from 'mongoose';

export const User = mongoose.model(
	'user',
	new mongoose.Schema(
		{
			// _id is a required field, and will be generated by Lucia
			_id: String,
			// email is not strictly required by Lucia, but we'll be using it
			email: String
		},
		// Let Lucia handle the _id field
		{ _id: false }
	)
);

mongoose.model(
	'session',
	new mongoose.Schema(
		{
			_id: String,
			user_id: {
				type: String,
				required: true
			},
			active_expires: {
				type: Number,
				required: true
			},
			idle_expires: {
				type: Number,
				required: true
			}
		},
		{ _id: false }
	)
);

mongoose.model(
	'key',
	new mongoose.Schema(
		{
			_id: String,
			user_id: {
				type: String,
				required: true
			},
			// Not strictly required by Lucia, but we'll be using it
			hashed_password: String,
			primary: {
				type: Boolean,
				required: true
			}
		},
		{ _id: false }
	)
);

export const auth = lucia({
	// Pass the existing mongoose connection to the adapter
	adapter: adapter(mongoose),
	// Let Lucia know which environment we're in
	env: dev ? 'DEV' : 'PROD',
	// When Lucia returns a user from the database, it will pass it through this function
	transformUserData: ({ id, email }) => ({
		userId: id,
		email
	})
});

// Expose the types for the rest of the app
export type Auth = typeof auth;
```

### Declare Lucia types

Using the exposed `Auth` type from above, let's now declare the rest of the types needed on the App.
In your `src/app.d.ts` file, add the following:

```ts
// src/app.d.ts
/// <reference types="lucia-auth" />
declare namespace Lucia {
	type Auth = import('$lib/server/lucia').Auth;
	type UserAttributes = {
		email: string;
	};
}

/// <reference types="@sveltejs/kit" />
declare namespace App {
	interface Locals {
		validate: import('@lucia-auth/sveltekit').Validate;
		validateUser: import('@lucia-auth/sveltekit').ValidateUser;
		setSession: import('@lucia-auth/sveltekit').SetSession;
	}
}
```

SvelteKit now knows about Lucia's types. We'll be using `locals` to validate the user's session and get the user's data.

### Create a MongoDB connection and add Lucia hooks

In `src/hooks.server.ts`, we'll create a connection to our MongoDB database. We'll also add Lucia's hooks to the SvelteKit app.

```ts
// From our .env file
import { MONGO_URI } from '$env/static/private';
import mongoose from 'mongoose';
import { auth } from '$lib/server/lucia';
import { handleHooks } from '@lucia-auth/sveltekit';

export const handle = handleHooks(auth);

try {
	await mongoose.connect(MONGO_URI, { autoIndex: false, dbName: 'test' });
} catch (error) {
	console.log(error);
}
```

If you have other hooks you want to run, use SvelteKit's <a target="_blank" href="https://kit.svelte.dev/docs/modules#sveltejs-kit-hooks-sequence"><code>sequence</code></a> function to run multiple.

<Admonition type='warning'>
    <div>
        Make sure Lucia's hook is first!
    </div>
</Admonition>

```ts
import { sequence } from '@sveltejs/kit/hooks';
import { auth } from '$lib/server/lucia';
import { handleHooks } from '@lucia-auth/sveltekit';

export const handle = sequence(handleHooks(auth), customHandle);
```

### Setup session refresh

Next, we'll use Lucia's `handleSession` function to refresh active user sessions, even across tabs!
We add the following in `src/routes/+layout.svelte`:

```svelte
<script lang="ts">
	import { page } from '$app/stores';
	import { handleSession } from '@lucia-auth/sveltekit/client';

	handleSession(page);
</script>

<slot />
```

### Pass the session data from server to client

Now, in our `src/+layout.server.ts` file, we'll use Lucia's `handleServerSession` function to send the session data to the client.

```ts
import { handleServerSession } from '@lucia-auth/sveltekit';

export const load = handleServerSession();
```

If you want to hook into this load function, simply pass in your own function as the first argument.

```ts
import { handleServerSession } from '@lucia-auth/sveltekit';
import type { LayoutServerLoadEvent } from './$types';

export const load = handleServerSession((event: LayoutServerLoadEvent) => {
	// Do something here
	// Lucia has exposed event.locals for use in this function
});
```

## Using Lucia

### Setup a sign up page

Let's create a sign up page. In `src/routes/signup/+page.svelte`, we'll add the following:

```svelte
<script lang="ts">
	// We use axios here, but you can use any HTTP client, such as fetch
	import axios from 'axios';
	import type { ActionResult } from '@sveltejs/kit';

	let email: string;
	let password: string;

	const signup = async () => {
		try {
			const { data } = await axios.postForm<ActionResult>('', {
				email,
				password
			});

			if (data.type === 'success') {
				email = password = '';
				suc = 'Sign up successful';
				// If successful, redirect to the home page
				window.location.href = '/';
			} else err = 'Something went wrong';
		} catch (error) {
			console.log(error);
			err = 'Something went wrong';
		}
	};
</script>

<form on:submit|preventDefault={signup}>
	<input
		class="input input-sm"
		type="email"
		autocomplete="email"
		placeholder="Email"
		bind:value={email}
	/>
	<input
		class="input input-sm"
		type="password"
		autocomplete="new-password"
		placeholder="Password"
		bind:value={password}
	/>

	<button class="my-4 btn btn-primary" type="submit"> Signup </button>
</form>
```

This signup form will post its data to the `/signup` <a href="https://kit.svelte.dev/docs/form-actions" target="_blank">action</a>, which we'll create next.

In `src/routes/signup/+page.server.ts` we'll add the following:

```ts
import { fail, redirect } from '@sveltejs/kit';
import { auth } from '$lib/server/lucia';
import type { PageServerLoad, Actions } from './$types';

// On page load, redirect authenticated users to the home page
export const load: PageServerLoad = async ({ locals }) => {
	const session = await locals.validate();
	if (session) throw redirect(302, '/');
	return {};
};

export const actions: Actions = {
	default: async ({ request, locals }) => {
		const form = await request.formData();
		const email = form.get('email');
		const password = form.get('password');

		// Validate form data
		if (typeof email !== 'string' || typeof password !== 'string') {
			return fail(400);
		}

		try {
			const user = await auth.createUser({
				key: {
					// The authentication provider we're using
					providerId: 'email',
					// The user's email
					providerUserId: email,
					password
				},
				attributes: {
					email
				}
			});

			// Create and set the session cookies
			const session = await auth.createSession(user.userId);
			locals.setSession(session);
		} catch {
			// Email already taken
			return fail(400);
		}
	}
};
```
